<template>
    <div class="overflow-wrap-break-word">
        <template v-if="editable">
            <token-edit-modal
                v-if="editable"
                :current-name="currentName"
                :has-release-period-prop="hasReleasePeriodProp"
                :is-owner="editable"
                :is-token-created="isTokenCreated"
                :is-token-exchanged="isTokenExchanged"
                :no-close="true"
                :precision="precision"
                :status-prop="statusProp"
                :twofa="twofa"
                :visible="showTokenEditModal"
                :websocket-url="websocketUrl"
                :release-address="releaseAddress"
                @close="closeTokenEditModal"
                @token-deploy-pending="$emit('token-deploy-pending')"
                @update-release-address="updateReleaseAddress"
                :airdrop-params="airdropParams"
                :key="reRenderModal"
            />
            <font-awesome-icon
                class="icon-edit c-pointer align-middle"
                icon="edit"
                transform="shrink-4 up-1.5"
                @click="editToken"
            />
        </template>
        <span>
            {{ currentName }}
        </span>
    </div>
</template>

<script>
import {library} from '@fortawesome/fontawesome-svg-core';
import {faEdit} from '@fortawesome/free-solid-svg-icons';
import {FontAwesomeIcon} from '@fortawesome/vue-fontawesome';
import {mixin as clickaway} from 'vue-clickaway';
import {WebSocketMixin, FiltersMixin, NotificationMixin, LoggerMixin} from '../../mixins/';
import TokenEditModal from '../modal/TokenEditModal';
import {AIRDROP_CREATED, AIRDROP_DELETED, TOKEN_NAME_CHANGED} from '../../utils/constants';

library.add(faEdit);

export default {
    name: 'TokenName',
    props: {
        editable: Boolean,
        hasReleasePeriodProp: Boolean,
        isTokenCreated: Boolean,
        identifier: String,
        name: String,
        precision: Number,
        statusProp: String,
        twofa: Boolean,
        websocketUrl: String,
        releaseAddress: String,
        airdropParams: Object,
    },
    components: {
        FontAwesomeIcon,
        TokenEditModal,
    },
    mixins: [WebSocketMixin, FiltersMixin, NotificationMixin, clickaway, LoggerMixin],
    data() {
        return {
            currentName: this.name,
            isTokenExchanged: true,
            isTokenNotDeployed: false,
            showTokenEditModal: false,
            reRenderModal: 0,
        };
    },
    mounted: function() {
        if (!this.editable) {
            return;
        }

        window.addEventListener('storage', (event) => {
            // Reload token page in case if token name was changed in another tab
            if (TOKEN_NAME_CHANGED === event.key && this.currentName === event.oldValue
                && this.currentName !== event.newValue
            ) {
                this.currentName = event.newValue;
                window.localStorage.removeItem(event.key);
                location.href = this.$routing.generate('token_show', {
                    name: this.currentName,
                });
            }

            // Reload token page in case if new token created/deleted in another tab
            if ((AIRDROP_CREATED === event.key || AIRDROP_DELETED === event.key)
                && this.currentName === event.newValue
            ) {
                window.localStorage.removeItem(event.key);
                location.reload();
            }
        });

        this.checkIfTokenExchanged();

        this.addMessageHandler((response) => {
            if (
                ('asset.update' === response.method && response.params[0].hasOwnProperty(this.identifier))
                || 'order.update' === response.method
            ) {
                this.checkIfTokenExchanged();
            }
        }, 'token-name-asset-update');
    },
    methods: {
        closeTokenEditModal: function() {
            this.showTokenEditModal = false;
        },
        checkIfTokenExchanged: function() {
            this.$axios.retry.get(this.$routing.generate('is_token_exchanged', {
                name: this.currentName,
            }))
            .then((res) => this.isTokenExchanged = res.data)
            .catch((err) => {
                this.notifyError('Can not fetch token data now. Try later');
                this.sendLogs('error', 'Can not fetch token data now', err);
            });
        },
        editToken: function() {
            if (!this.editable) {
                return;
            }

            this.showTokenEditModal = true;
            this.reRenderModal++;
        },
        updateReleaseAddress: function() {
            this.releaseAddress = '0x';
        },
    },
};
</script>

